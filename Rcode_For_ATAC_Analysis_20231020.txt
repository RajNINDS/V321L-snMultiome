#------------------------------------------------------------------------------
# Code Call Organization By: Kory R Johnson
# Affiliation: NINDS/NIH Bioinformatics Core
# Contact information: johnsonko@mail.nih.gov
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# Launch
#------------------------------------------------------------------------------

cd /data/johnsonko/Analysis_Projects/Lorna_Role/Rajebhosale_Prithviraj/scRNA_Seq_Project_20230522

sinteractive --mem=200g --cpus-per-task=4 --time 36:00:00 --gres=lscratch:200 # augur

#------------------------------------------------------------------------------
# Set-up
#------------------------------------------------------------------------------

module load R Rstudio
rstudio &

#------------------------------------------------------------------------------
# Initialize
#------------------------------------------------------------------------------

rm(list=ls())
options(object.size=Inf)

setwd("/data/johnsonko/Analysis_Projects/Lorna_Role/Rajebhosale_Prithviraj/scRNA_Seq_Project_20230522/GEX")

#------------------------------------------------------------------------------
# Install
#------------------------------------------------------------------------------

library(remotes)

# install.packages("devtools")
library(devtools)

# install.packages("harmony")
library(harmony)

# BiocManager::install("DropletUtils")
library(DropletUtils)

# BiocManager::install("scDblFinder")
library(scDblFinder)

# remotes::install_version("Seurat", version = "4.2.0")
library(Seurat)
library(SeuratData)
library(cowplot)

# remotes::install_github('satijalab/azimuth', version = "0.4.6")
library(Azimuth)

# BiocManager::install("SingleCellExperiment")
library(SingleCellExperiment)

# BiocManager::install("ggplot2")
library(ggplot2)

# BiocManager::install("scales")
library(scales)

# BiocManager::install("dplyr")
library("dplyr")

# BiocManager::install("clustree")
library("clustree")

# BiocManager::install("scater")
library("scater")

# BiocManager::install("Signac")
library(Signac)

# BiocManager::install("EnsDb.Mmusculus.v79")
library(EnsDb.Mmusculus.v79)

# BiocManager::install("GenomicRanges")
library(GenomicRanges)

# BiocManager::install("future")
library(future)

# BiocManager::install("stringr")
library(stringr)

# BiocManager::install("openxlsx")
library(openxlsx)

# BiocManager::install("pheatmap")
library(pheatmap)

'%!in%' <- Negate('%in%')

# BiocManager::install("BSgenome.Mmusculus.UCSC.mm10")
library(BSgenome.Mmusculus.UCSC.mm10)

# BiocManager::install("chromVAR")
library(chromVAR)

# BiocManager::install("JASPAR2020")
library(JASPAR2020)

# BiocManager::install("TFBSTools")
library(TFBSTools)

# BiocManager::install("motifmatchr")
library(motifmatchr)

# devtools::install_github("neurorestore/Augur")
library(Augur)
library(BiocParallel)

# BiocManager::install("openxlsx")
library(openxlsx)

# BiocManager::install("patchwork")
library(patchwork)

remotes::install_github("satijalab/seurat-wrappers")
library(monocle3)
library(scales)

#------------------------------------------------------------------------------
# load GEX final object
#------------------------------------------------------------------------------

final.annotated.harmony.go <- readRDS("final.curated.harmony.go_20230612.rds")

#------------------------------------------------------------------------------
# Perform by sample preprocessing
# https://stuartlab.org/signac/articles/mouse_brain_vignette
#------------------------------------------------------------------------------

setwd("/data/johnsonko/Analysis_Projects/Lorna_Role/Rajebhosale_Prithviraj/scRNA_Seq_Project_20230522/ATAC")

# read in peak sets

LL_F_NAC_atac_bed <- read.table("LL_F_NAC_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_M_NAC_atac_bed <- read.table("LL_M_NAC_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_F_VHIPP_atac_bed <- read.table("LL_F_VHIPP_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_M_VHIPP_atac_bed <- read.table("LL_M_VHIPP_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_F1_DG_atac_bed <- read.table("LL_F1_DG_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_F2_DG_atac_bed <- read.table("LL_F2_DG_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_M1_DG_atac_bed <- read.table("LL_M1_DG_atac_peaks.bed",col.names = c("chr", "start", "end"))

LL_M2_DG_atac_bed <- read.table("LL_M2_DG_atac_peaks.bed",col.names = c("chr", "start", "end"))

# convert to genomic ranges

gr.LL.F.NAC <- makeGRangesFromDataFrame(LL_F_NAC_atac_bed)
gr.LL.M.NAC <- makeGRangesFromDataFrame(LL_M_NAC_atac_bed)
gr.LL.F.VHIPP <- makeGRangesFromDataFrame(LL_F_VHIPP_atac_bed)
gr.LL.M.VHIPP <- makeGRangesFromDataFrame(LL_M_VHIPP_atac_bed)
gr.LL.F1.DG <- makeGRangesFromDataFrame(LL_F1_DG_atac_bed)
gr.LL.F2.DG <- makeGRangesFromDataFrame(LL_F2_DG_atac_bed)
gr.LL.M1.DG <- makeGRangesFromDataFrame(LL_M1_DG_atac_bed)
gr.LL.M2.DG <- makeGRangesFromDataFrame(LL_M2_DG_atac_bed)

# load metadata

md.LL.F.NAC <- read.table(
  file = "LL_F_NAC_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.M.NAC <- read.table(
  file = "LL_M_NAC_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.F.VHIPP <- read.table(
  file = "LL_F_VHIPP_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.M.VHIPP <- read.table(
  file = "LL_M_VHIPP_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.F1.DG <- read.table(
  file = "LL_F1_DG_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.F2.DG <- read.table(
  file = "LL_F2_DG_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.M1.DG <- read.table(
  file = "LL_M1_DG_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

md.LL.M2.DG <- read.table(
  file = "LL_M2_DG_per_barcode_metrics.csv",
  stringsAsFactors = FALSE,
  sep = ",",
  header = TRUE,
  row.names = 1
)

# perform an initial filtering of low count cells

md.LL.F.NAC <- md.LL.F.NAC[md.LL.F.NAC$atac_fragments > 500,]
md.LL.M.NAC <- md.LL.M.NAC[ md.LL.M.NAC$atac_fragments > 500,]
md.LL.F.VHIPP <- md.LL.F.VHIPP[md.LL.F.VHIPP$atac_fragments > 500,]
md.LL.M.VHIPP <- md.LL.M.VHIPP[md.LL.M.VHIPP$atac_fragments > 500,]
md.LL.F1.DG <- md.LL.F1.DG[md.LL.F1.DG$atac_fragments > 500,]
md.LL.F2.DG <- md.LL.F2.DG[md.LL.F2.DG$atac_fragments > 500,]
md.LL.M1.DG <- md.LL.M1.DG[md.LL.M1.DG$atac_fragments > 500,]
md.LL.M2.DG <- md.LL.M2.DG[md.LL.M2.DG$atac_fragments > 500,]

# create fragment objects

frags.LL.F.NAC <- CreateFragmentObject(
  path = "LL_F_NAC_atac_fragments.tsv.gz",
  cells = rownames(md.LL.F.NAC)
)

frags.LL.M.NAC <- CreateFragmentObject(
  path = "LL_M_NAC_atac_fragments.tsv.gz",
  cells = rownames(md.LL.M.NAC)
)

frags.LL.F.VHIPP <- CreateFragmentObject(
  path = "LL_F_VHIPP_atac_fragments.tsv.gz",
  cells = rownames(md.LL.F.VHIPP)
)

frags.LL.M.VHIPP <- CreateFragmentObject(
  path = "LL_M_VHIPP_atac_fragments.tsv.gz",
  cells = rownames(md.LL.M.VHIPP)
)

frags.LL.F1.DG <- CreateFragmentObject(
  path = "LL_F1_DG_atac_fragments.tsv.gz",
  cells = rownames(md.LL.F1.DG)
)

frags.LL.F2.DG <- CreateFragmentObject(
  path = "LL_F2_DG_atac_fragments.tsv.gz",
  cells = rownames(md.LL.F2.DG)
)

frags.LL.M1.DG <- CreateFragmentObject(
  path = "LL_M1_DG_atac_fragments.tsv.gz",
  cells = rownames(md.LL.M1.DG)
)

frags.LL.M2.DG <- CreateFragmentObject(
  path = "LL_M2_DG_atac_fragments.tsv.gz",
  cells = rownames(md.LL.M2.DG)
)

# Quantify peaks in each dataset

LL.F.NAC.counts <- FeatureMatrix(
  fragments = frags.LL.F.NAC,
  features = reduce(x=c(gr.LL.F.NAC)),
  cells = rownames(md.LL.F.NAC)
)

LL.M.NAC.counts <- FeatureMatrix(
  fragments = frags.LL.M.NAC,
  features = reduce(x=c(gr.LL.M.NAC)),
  cells = rownames(md.LL.M.NAC)
)

LL.F.VHIPP.counts <- FeatureMatrix(
  fragments = frags.LL.F.VHIPP,
  features = reduce(x=c(gr.LL.F.VHIPP)),
  cells = rownames(md.LL.F.VHIPP)
)

LL.M.VHIPP.counts <- FeatureMatrix(
  fragments = frags.LL.M.VHIPP,
  features = reduce(x=c(gr.LL.M.VHIPP)),
  cells = rownames(md.LL.M.VHIPP)
)

LL.F1.DG.counts <- FeatureMatrix(
  fragments = frags.LL.F1.DG,
  features = reduce(x=c(gr.LL.F1.DG)),
  cells = rownames(md.LL.F1.DG)
)

LL.F2.DG.counts <- FeatureMatrix(
  fragments = frags.LL.F2.DG,
  features = reduce(x=c(gr.LL.F2.DG)),
  cells = rownames(md.LL.F2.DG)
)

LL.M1.DG.counts <- FeatureMatrix(
  fragments = frags.LL.M1.DG,
  features = reduce(x=c(gr.LL.M1.DG)),
  cells = rownames(md.LL.M1.DG)
)

LL.M2.DG.counts <- FeatureMatrix(
  fragments = frags.LL.M2.DG,
  features = reduce(x=c(gr.LL.M2.DG)),
  cells = rownames(md.LL.M2.DG)
)

# Create Seurat objects

LL.F.NAC.chrom_assay <- CreateChromatinAssay(counts = LL.F.NAC.counts, fragments = frags.LL.F.NAC)
LL.M.NAC.chrom_assay <- CreateChromatinAssay(counts = LL.M.NAC.counts, fragments = frags.LL.M.NAC)
LL.F.VHIPP.chrom_assay <- CreateChromatinAssay(counts = LL.F.VHIPP.counts, fragments = frags.LL.F.VHIPP)
LL.M.VHIPP.chrom_assay <- CreateChromatinAssay(counts = LL.M.VHIPP.counts, fragments = frags.LL.M.VHIPP)
LL.F1.DG.chrom_assay <- CreateChromatinAssay(counts = LL.F1.DG.counts, fragments = frags.LL.F1.DG)
LL.F2.DG.chrom_assay <- CreateChromatinAssay(counts = LL.F2.DG.counts, fragments = frags.LL.F2.DG)
LL.M1.DG.chrom_assay <- CreateChromatinAssay(counts = LL.M1.DG.counts, fragments = frags.LL.M1.DG)
LL.M2.DG.chrom_assay <- CreateChromatinAssay(counts = LL.M2.DG.counts, fragments = frags.LL.M2.DG)

LL.F.NAC.atac <- CreateSeuratObject(LL.F.NAC.chrom_assay, assay = "ATAC", meta.data=md.LL.F.NAC)
LL.M.NAC.atac <- CreateSeuratObject(LL.M.NAC.chrom_assay, assay = "ATAC", meta.data=md.LL.M.NAC)
LL.F.VHIPP.atac <- CreateSeuratObject(LL.F.VHIPP.chrom_assay, assay = "ATAC", meta.data=md.LL.F.VHIPP)
LL.M.VHIPP.atac <- CreateSeuratObject(LL.M.VHIPP.chrom_assay, assay = "ATAC", meta.data=md.LL.M.VHIPP)
LL.F1.DG.atac <- CreateSeuratObject(LL.F1.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.F1.DG)
LL.F2.DG.atac <- CreateSeuratObject(LL.F2.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.F2.DG)
LL.M1.DG.atac <- CreateSeuratObject(LL.M1.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.M1.DG)
LL.M2.DG.atac <- CreateSeuratObject(LL.M2.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.M2.DG)

# Add information to identify dataset of origin

Idents(LL.F.NAC.atac) <- "LL.F.NAC"
Idents(LL.M.NAC.atac) <- "LL.M.NAC"
Idents(LL.F.VHIPP.atac) <- "LL.F.VHIPP"
Idents(LL.M.VHIPP.atac) <- "LL.M.VHIPP"
Idents(LL.F1.DG.atac) <- "LL.F1.DG"
Idents(LL.F2.DG.atac) <- "LL.F2.DG"
Idents(LL.M1.DG.atac) <- "LL.M1.DG"
Idents(LL.M2.DG.atac) <- "LL.M2.DG"

LL.F.NAC.atac$dataset <- "LL.F.NAC"
LL.M.NAC.atac$dataset <- "LL.M.NAC"
LL.F.VHIPP.atac$dataset <- "LL.F.VHIPP"
LL.M.VHIPP.atac$dataset <- "LL.M.VHIPP"
LL.F1.DG.atac$dataset <- "LL.F1.DG"
LL.F2.DG.atac$dataset <- "LL.F2.DG"
LL.M1.DG.atac$dataset <- "LL.M1.DG"
LL.M2.DG.atac$dataset <- "LL.M2.DG"

# add gene annotations

annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevels(annotations) <- paste0('chr', seqlevels(annotations))
genome(annotations) <- "mm10"

Annotation(LL.F.NAC.atac) <- annotations
Annotation(LL.M.NAC.atac) <- annotations
Annotation(LL.F.VHIPP.atac) <- annotations
Annotation(LL.M.VHIPP.atac) <- annotations
Annotation(LL.F1.DG.atac) <- annotations
Annotation(LL.F2.DG.atac) <- annotations
Annotation(LL.M1.DG.atac) <- annotations
Annotation(LL.M2.DG.atac) <- annotations

# calculate Nucleosome Signal metric

LL.F.NAC.atac <- NucleosomeSignal(object = LL.F.NAC.atac)
LL.M.NAC.atac <- NucleosomeSignal(object = LL.M.NAC.atac)
LL.F.VHIPP.atac <- NucleosomeSignal(object = LL.F.VHIPP.atac)
LL.M.VHIPP.atac <- NucleosomeSignal(object = LL.M.VHIPP.atac)
LL.F1.DG.atac <- NucleosomeSignal(object = LL.F1.DG.atac)
LL.F2.DG.atac <- NucleosomeSignal(object = LL.F2.DG.atac)
LL.M1.DG.atac <- NucleosomeSignal(object = LL.M1.DG.atac)
LL.M2.DG.atac <- NucleosomeSignal(object = LL.M2.DG.atac)

# define low vs high nucleosomal signal strength

LL.F.NAC.atac$nucleosome_group <- ifelse(LL.F.NAC.atac$nucleosome_signal > quantile(LL.F.NAC.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.M.NAC.atac$nucleosome_group <- ifelse(LL.M.NAC.atac$nucleosome_signal >  quantile(LL.M.NAC.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.F.VHIPP.atac$nucleosome_group <- ifelse(LL.F.VHIPP.atac$nucleosome_signal >  quantile(LL.F.VHIPP.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.M.VHIPP.atac$nucleosome_group <- ifelse(LL.M.VHIPP.atac$nucleosome_signal >  quantile(LL.M.VHIPP.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.F1.DG.atac$nucleosome_group <- ifelse(LL.F1.DG.atac$nucleosome_signal >  quantile(LL.F1.DG.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.F2.DG.atac$nucleosome_group <- ifelse(LL.F2.DG.atac$nucleosome_signal >  quantile(LL.F2.DG.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.M1.DG.atac$nucleosome_group <- ifelse(LL.M1.DG.atac$nucleosome_signal >  quantile(LL.M1.DG.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

LL.M2.DG.atac$nucleosome_group <- ifelse(LL.M2.DG.atac$nucleosome_signal >  quantile(LL.M2.DG.atac$nucleosome_signal,0.25), 'NS > 25th', 'NS < 25th')

# plot low vs high nucleosomal signal strength

svg("1_atac_pre_merge_inspection_LL_F_NAC_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.F.NAC.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.F.NAC.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_M_NAC_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.M.NAC.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.M.NAC.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_F_VHIPP_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.F.VHIPP.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.F.VHIPP.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_M_VHIPP_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.M.VHIPP.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.M.VHIPP.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_F1_DG_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.F1.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.F1.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_F2_DG_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.F2.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.F2.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_M1_DG_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.M1.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.M1.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

svg("1_atac_pre_merge_inspection_LL_M2_DG_nucleosomal_signal_strength.svg")
print(FragmentHistogram(object = LL.M2.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000'))
dev.off()
FragmentHistogram(object = LL.M2.DG.atac, group.by = 'nucleosome_group', region = 'chr1-1-10000000')

# inspect high vs low TSS enrichment signal strength

LL.F.NAC.atac <- TSSEnrichment(LL.F.NAC.atac, fast = FALSE)
LL.M.NAC.atac <- TSSEnrichment(LL.M.NAC.atac, fast = FALSE)
LL.F.VHIPP.atac <- TSSEnrichment(LL.F.VHIPP.atac, fast = FALSE)
LL.M.VHIPP.atac <- TSSEnrichment(LL.M.VHIPP.atac, fast = FALSE)
LL.F1.DG.atac <- TSSEnrichment(LL.F1.DG.atac, fast = FALSE)
LL.F2.DG.atac <- TSSEnrichment(LL.F2.DG.atac, fast = FALSE)
LL.M1.DG.atac <- TSSEnrichment(LL.M1.DG.atac, fast = FALSE)
LL.M2.DG.atac <- TSSEnrichment(LL.M2.DG.atac, fast = FALSE)

# inspect high vs low TSS enrichment

LL.F.NAC.atac$high.tss <- ifelse(LL.F.NAC.atac$TSS.enrichment > quantile(LL.F.NAC.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL.F.NAC_enrichment.svg")
print(TSSPlot(LL.F.NAC.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.F.NAC.atac, group.by = 'high.tss') + NoLegend()

LL.M.NAC.atac$high.tss <- ifelse(LL.M.NAC.atac$TSS.enrichment > quantile(LL.M.NAC.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL.M.NAC_enrichment.svg")
print(TSSPlot(LL.M.NAC.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.M.NAC.atac, group.by = 'high.tss') + NoLegend()

LL.F.VHIPP.atac$high.tss <- ifelse(LL.F.VHIPP.atac$TSS.enrichment > quantile(LL.F.VHIPP.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL_F_VHIPP_enrichment.svg")
print(TSSPlot(LL.F.VHIPP.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.F.VHIPP.atac, group.by = 'high.tss') + NoLegend()

LL.M.VHIPP.atac$high.tss <- ifelse(LL.M.VHIPP.atac$TSS.enrichment > quantile(LL.M.VHIPP.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL_M_VHIPP_enrichment.svg")
print(TSSPlot(LL.M.VHIPP.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.M.VHIPP.atac, group.by = 'high.tss') + NoLegend()

LL.F1.DG.atac$high.tss <- ifelse(LL.F1.DG.atac$TSS.enrichment > quantile(LL.F1.DG.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL_F1_DG_TSS_enrichment.svg")
print(TSSPlot(LL.F1.DG.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.F1.DG.atac, group.by = 'high.tss') + NoLegend()

LL.F2.DG.atac$high.tss <- ifelse(LL.F2.DG.atac$TSS.enrichment > quantile(LL.F2.DG.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL_F2_DG_TSS_enrichment.svg")
print(TSSPlot(LL.F2.DG.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.F2.DG.atac, group.by = 'high.tss') + NoLegend()

LL.M1.DG.atac$high.tss <- ifelse(LL.M1.DG.atac$TSS.enrichment > quantile(LL.M1.DG.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL_M1_DG_TSS_enrichment.svg")
print(TSSPlot(LL.M1.DG.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.M1.DG.atac, group.by = 'high.tss') + NoLegend()

LL.M2.DG.atac$high.tss <- ifelse(LL.M2.DG.atac$TSS.enrichment > quantile(LL.M2.DG.atac$TSS.enrichment,0.25), 'TSS > 25th', 'TSS < 25th')
svg("2_atac_pre_merge_inspection_LL_M2_DG_TSS_enrichment.svg")
print(TSSPlot(LL.M2.DG.atac, group.by = 'high.tss') + NoLegend())
dev.off()
TSSPlot(LL.M2.DG.atac, group.by = 'high.tss') + NoLegend()

# quality inspect LL.F.NAC.atac

LL.F.NAC.atac$log2_peak_region_fragments <- log2(LL.F.NAC.atac$atac_peak_region_fragments+2)
LL.F.NAC.atac$log2_nCount_ATAC <- log2(LL.F.NAC.atac$nCount_ATAC+2)
LL.F.NAC.atac$pct_reads_in_peaks <- (LL.F.NAC.atac$atac_peak_region_fragments / LL.F.NAC.atac$atac_fragments) * 100
LL.F.NAC.atac$log2_atac_TSS_fragments <- log2(LL.F.NAC.atac$atac_TSS_fragments+2)
LL.F.NAC.atac$log2_nucleosome_signal <- log2(LL.F.NAC.atac$nucleosome_signal+2)
LL.F.NAC.atac$log2_TSS_enrichment <- log2(LL.F.NAC.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL_F_NAC_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL_F_NAC_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL_F_NAC_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL_F_NAC_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL_F_NAC_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL_F_NAC_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL_F_NAC_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL_F_NAC_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.NAC.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL_F_NAC_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.F.NAC.atac,"LL.F.NAC.atac.pre.hard.filter.rds")

LL.F.NAC.atac <- subset(
  x = LL.F.NAC.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.NAC.atac@meta.data$log2_nucleosome_signal))))
LL.F.NAC.atac

saveRDS(LL.F.NAC.atac,"LL.F.NAC.atac.post.hard.filter.rds")

# quality inspect LL.M.NAC.atac

LL.M.NAC.atac$log2_peak_region_fragments <- log2(LL.M.NAC.atac$atac_peak_region_fragments+2)
LL.M.NAC.atac$log2_nCount_ATAC <- log2(LL.M.NAC.atac$nCount_ATAC+2)
LL.M.NAC.atac$pct_reads_in_peaks <- (LL.M.NAC.atac$atac_peak_region_fragments / LL.M.NAC.atac$atac_fragments) * 100
LL.M.NAC.atac$log2_atac_TSS_fragments <- log2(LL.M.NAC.atac$atac_TSS_fragments+2)
LL.M.NAC.atac$log2_nucleosome_signal <- log2(LL.M.NAC.atac$nucleosome_signal+2)
LL.M.NAC.atac$log2_TSS_enrichment <- log2(LL.M.NAC.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.M.NAC_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.M.NAC_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.M.NAC_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.M.NAC_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.M.NAC_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.M.NAC_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.M.NAC_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.M.NAC_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.NAC.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.M.NAC_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.M.NAC.atac,"LL.M.NAC.atac.pre.hard.filter.rds")

LL.M.NAC.atac <- subset(
  x = LL.M.NAC.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.NAC.atac@meta.data$log2_nucleosome_signal))))
LL.M.NAC.atac

saveRDS(LL.M.NAC.atac,"LL.M.NAC.atac.post.hard.filter.rds")

# quality inspect LL.F.VHIPP.atac

LL.F.VHIPP.atac$log2_peak_region_fragments <- log2(LL.F.VHIPP.atac$atac_peak_region_fragments+2)
LL.F.VHIPP.atac$log2_nCount_ATAC <- log2(LL.F.VHIPP.atac$nCount_ATAC+2)
LL.F.VHIPP.atac$pct_reads_in_peaks <- (LL.F.VHIPP.atac$atac_peak_region_fragments / LL.F.VHIPP.atac$atac_fragments) * 100
LL.F.VHIPP.atac$log2_atac_TSS_fragments <- log2(LL.F.VHIPP.atac$atac_TSS_fragments+2)
LL.F.VHIPP.atac$log2_nucleosome_signal <- log2(LL.F.VHIPP.atac$nucleosome_signal+2)
LL.F.VHIPP.atac$log2_TSS_enrichment <- log2(LL.F.VHIPP.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.F.VHIPP_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.F.VHIPP_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.F.VHIPP_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.F.VHIPP_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.F.VHIPP_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.F.VHIPP_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F.VHIPP.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.F.VHIPP_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.F.VHIPP.atac,"LL.F.VHIPP.atac.pre.hard.filter.rds")

LL.F.VHIPP.atac <- subset(
  x = LL.F.VHIPP.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F.VHIPP.atac@meta.data$log2_nucleosome_signal))))
LL.F.VHIPP.atac

saveRDS(LL.F.VHIPP.atac,"LL.F.VHIPP.atac.post.hard.filter.rds")

# quality inspect LL.M.VHIPP.atac

LL.M.VHIPP.atac$log2_peak_region_fragments <- log2(LL.M.VHIPP.atac$atac_peak_region_fragments+2)
LL.M.VHIPP.atac$log2_nCount_ATAC <- log2(LL.M.VHIPP.atac$nCount_ATAC+2)
LL.M.VHIPP.atac$pct_reads_in_peaks <- (LL.M.VHIPP.atac$atac_peak_region_fragments / LL.M.VHIPP.atac$atac_fragments) * 100
LL.M.VHIPP.atac$log2_atac_TSS_fragments <- log2(LL.M.VHIPP.atac$atac_TSS_fragments+2)
LL.M.VHIPP.atac$log2_nucleosome_signal <- log2(LL.M.VHIPP.atac$nucleosome_signal+2)
LL.M.VHIPP.atac$log2_TSS_enrichment <- log2(LL.M.VHIPP.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.M.VHIPP_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.M.VHIPP_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.M.VHIPP_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.M.VHIPP_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.M.VHIPP_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.M.VHIPP_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M.VHIPP.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.M.VHIPP_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.M.VHIPP.atac,"LL.M.VHIPP.atac.pre.hard.filter.rds")

LL.M.VHIPP.atac <- subset(
  x = LL.M.VHIPP.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M.VHIPP.atac@meta.data$log2_nucleosome_signal))))
LL.M.VHIPP.atac

saveRDS(LL.M.VHIPP.atac,"LL.M.VHIPP.atac.post.hard.filter.rds")

# quality inspect LL.F1.DG.atac

LL.F1.DG.atac$log2_peak_region_fragments <- log2(LL.F1.DG.atac$atac_peak_region_fragments+2)
LL.F1.DG.atac$log2_nCount_ATAC <- log2(LL.F1.DG.atac$nCount_ATAC+2)
LL.F1.DG.atac$pct_reads_in_peaks <- (LL.F1.DG.atac$atac_peak_region_fragments / LL.F1.DG.atac$atac_fragments) * 100
LL.F1.DG.atac$log2_atac_TSS_fragments <- log2(LL.F1.DG.atac$atac_TSS_fragments+2)
LL.F1.DG.atac$log2_nucleosome_signal <- log2(LL.F1.DG.atac$nucleosome_signal+2)
LL.F1.DG.atac$log2_TSS_enrichment <- log2(LL.F1.DG.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.F1.DG_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.F1.DG_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.F1.DG_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.F1.DG_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.F1.DG_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.F1.DG_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.F1.DG_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.F1.DG_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F1.DG.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.F1.DG_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.F1.DG.atac,"LL.F1.DG.atac.pre.hard.filter.rds")

LL.F1.DG.atac <- subset(
  x = LL.F1.DG.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F1.DG.atac@meta.data$log2_nucleosome_signal))))
LL.F1.DG.atac

saveRDS(LL.F1.DG.atac,"LL.F1.DG.atac.post.hard.filter.rds")

# quality inspect LL.F2.DG.atac

LL.F2.DG.atac$log2_peak_region_fragments <- log2(LL.F2.DG.atac$atac_peak_region_fragments+2)
LL.F2.DG.atac$log2_nCount_ATAC <- log2(LL.F2.DG.atac$nCount_ATAC+2)
LL.F2.DG.atac$pct_reads_in_peaks <- (LL.F2.DG.atac$atac_peak_region_fragments / LL.F2.DG.atac$atac_fragments) * 100
LL.F2.DG.atac$log2_atac_TSS_fragments <- log2(LL.F2.DG.atac$atac_TSS_fragments+2)
LL.F2.DG.atac$log2_nucleosome_signal <- log2(LL.F2.DG.atac$nucleosome_signal+2)
LL.F2.DG.atac$log2_TSS_enrichment <- log2(LL.F2.DG.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.F2.DG_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.F2.DG_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.F2.DG_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.F2.DG_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.F2.DG_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.F2.DG_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.F2.DG_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.F2.DG_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.F2.DG.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.F2.DG_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.F2.DG.atac,"LL.F2.DG.atac.pre.hard.filter.rds")

LL.F2.DG.atac <- subset(
  x = LL.F2.DG.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.F2.DG.atac@meta.data$log2_nucleosome_signal))))
LL.F2.DG.atac

saveRDS(LL.F2.DG.atac,"LL.F2.DG.atac.post.hard.filter.rds")

# quality inspect LL.M1.DG.atac

LL.M1.DG.atac$log2_peak_region_fragments <- log2(LL.M1.DG.atac$atac_peak_region_fragments+2)
LL.M1.DG.atac$log2_nCount_ATAC <- log2(LL.M1.DG.atac$nCount_ATAC+2)
LL.M1.DG.atac$pct_reads_in_peaks <- (LL.M1.DG.atac$atac_peak_region_fragments / LL.M1.DG.atac$atac_fragments) * 100
LL.M1.DG.atac$log2_atac_TSS_fragments <- log2(LL.M1.DG.atac$atac_TSS_fragments+2)
LL.M1.DG.atac$log2_nucleosome_signal <- log2(LL.M1.DG.atac$nucleosome_signal+2)
LL.M1.DG.atac$log2_TSS_enrichment <- log2(LL.M1.DG.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.M1.DG_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.M1.DG_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.M1.DG_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.M1.DG_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.M1.DG_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.M1.DG_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.M1.DG_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.M1.DG_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M1.DG.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.M1.DG_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.M1.DG.atac,"LL.M1.DG.atac.pre.hard.filter.rds")

LL.M1.DG.atac <- subset(
  x = LL.M1.DG.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M1.DG.atac@meta.data$log2_nucleosome_signal))))
LL.M1.DG.atac

saveRDS(LL.M1.DG.atac,"LL.M1.DG.atac.post.hard.filter.rds")

# quality inspect LL.M2.DG.atac

LL.M2.DG.atac$log2_peak_region_fragments <- log2(LL.M2.DG.atac$atac_peak_region_fragments+2)
LL.M2.DG.atac$log2_nCount_ATAC <- log2(LL.M2.DG.atac$nCount_ATAC+2)
LL.M2.DG.atac$pct_reads_in_peaks <- (LL.M2.DG.atac$atac_peak_region_fragments / LL.M2.DG.atac$atac_fragments) * 100
LL.M2.DG.atac$log2_atac_TSS_fragments <- log2(LL.M2.DG.atac$atac_TSS_fragments+2)
LL.M2.DG.atac$log2_nucleosome_signal <- log2(LL.M2.DG.atac$nucleosome_signal+2)
LL.M2.DG.atac$log2_TSS_enrichment <- log2(LL.M2.DG.atac$TSS.enrichment+2)

# nCount

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("3_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_nCount.svg")
print(v)
dev.off()

svg("4_atac_pre_merge_inspection_LL.M2.DG_density_plot_log2_nCount.svg")
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- v + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("5_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_nCount_with_cutoff_selection.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("6_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("7_atac_pre_merge_inspection_LL.M2.DG_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments)))),lty=5)
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("8_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("9_atac_pre_merge_inspection_LL.M2.DG_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("10_atac_pre_merge_inspection_LL.M2.DG_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks)))),lty=5)
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("11_atac_pre_merge_inspection_LL.M2.DG_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_atac_TSS_fragments

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("12_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("13_atac_pre_merge_inspection_LL.M2.DG_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v
svg("14_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# log2_TSS_enrichment

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("15_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("16_atac_pre_merge_inspection_LL.M2.DG_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment)))),lty=5)
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v
svg("17_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

# 

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("18_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("19_atac_pre_merge_inspection_LL.M2.DG_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=2)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=3)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-3*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=4)
abline(v=(mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-4*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal)))),lty=5)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = LL.M2.DG.atac,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("20_atac_pre_merge_inspection_LL.M2.DG_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

saveRDS(LL.M2.DG.atac,"LL.M2.DG.atac.pre.hard.filter.rds")

LL.M2.DG.atac <- subset(
  x = LL.M2.DG.atac,
  subset = log2_nCount_ATAC > mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_nCount_ATAC < mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nCount_ATAC))) & 
log2_peak_region_fragments > mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))) & 
log2_peak_region_fragments < mean(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_peak_region_fragments))) & 
pct_reads_in_peaks > mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))) & 
pct_reads_in_peaks < mean(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$pct_reads_in_peaks))) & 
log2_atac_TSS_fragments > mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_atac_TSS_fragments < mean(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_atac_TSS_fragments))) & 
log2_TSS_enrichment > mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_TSS_enrichment < mean(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_TSS_enrichment))) & 
log2_nucleosome_signal < mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))) &
log2_nucleosome_signal > mean(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))+(-2*sd(as.numeric(LL.M2.DG.atac@meta.data$log2_nucleosome_signal))))
LL.M2.DG.atac

saveRDS(LL.M2.DG.atac,"LL.M2.DG.atac.post.hard.filter.rds")

# perform informal merge to get passing cells

combined <- merge(
  x = LL.F.NAC.atac,
  y = list(LL.M.NAC.atac, LL.F.VHIPP.atac, LL.M.VHIPP.atac,LL.F1.DG.atac,LL.F2.DG.atac,LL.M1.DG.atac,LL.M2.DG.atac),
  add.cell.ids = c("LL.F.NAC", "LL.M.NAC", "LL.F.VHIPP", "LL.M.VHIPP", "LL.F1.DG", "LL.F2.DG", "LL.M1.DG", "LL.M2.DG")
)

capture.post.hard.filter.cells <- rownames(combined@meta.data)

#------------------------------------------------------------------------------
# Perform formal merge across samples using common peak set
# https://stuartlab.org/signac/articles/merging
#------------------------------------------------------------------------------

# Create a unified set of peaks to quantify in each dataset

combined.peaks <- reduce(x=c(gr.LL.F.NAC,
gr.LL.M.NAC,
gr.LL.F.VHIPP,
gr.LL.M.VHIPP,
gr.LL.F1.DG,
gr.LL.F2.DG,
gr.LL.M1.DG,
gr.LL.M2.DG))

# Filter out bad peaks based on length

peakwidths <- width(combined.peaks)
combined.peaks <- combined.peaks[peakwidths  < 10000 & peakwidths > 20]
combined.peaks

# Quantify peaks in each dataset

LL.F.NAC.counts <- FeatureMatrix(
  fragments = frags.LL.F.NAC,
  features = combined.peaks,
  cells = rownames(md.LL.F.NAC)
)

LL.M.NAC.counts <- FeatureMatrix(
  fragments = frags.LL.M.NAC,
  features = combined.peaks,
  cells = rownames(md.LL.M.NAC)
)

LL.F.VHIPP.counts <- FeatureMatrix(
  fragments = frags.LL.F.VHIPP,
  features = combined.peaks,
  cells = rownames(md.LL.F.VHIPP)
)

LL.M.VHIPP.counts <- FeatureMatrix(
  fragments = frags.LL.M.VHIPP,
  features = combined.peaks,
  cells = rownames(md.LL.M.VHIPP)
)

LL.F1.DG.counts <- FeatureMatrix(
  fragments = frags.LL.F1.DG,
  features = combined.peaks,
  cells = rownames(md.LL.F1.DG)
)

LL.F2.DG.counts <- FeatureMatrix(
  fragments = frags.LL.F2.DG,
  features = combined.peaks,
  cells = rownames(md.LL.F2.DG)
)

LL.M1.DG.counts <- FeatureMatrix(
  fragments = frags.LL.M1.DG,
  features = combined.peaks,
  cells = rownames(md.LL.M1.DG)
)

LL.M2.DG.counts <- FeatureMatrix(
  fragments = frags.LL.M2.DG,
  features = combined.peaks,
  cells = rownames(md.LL.M2.DG)
)

# Create Seurat objects

LL.F.NAC.chrom_assay <- CreateChromatinAssay(counts = LL.F.NAC.counts, fragments = frags.LL.F.NAC)
LL.F.NAC.atac.final <- CreateSeuratObject(LL.F.NAC.chrom_assay, assay = "ATAC", meta.data=md.LL.F.NAC)

LL.M.NAC.chrom_assay <- CreateChromatinAssay(counts = LL.M.NAC.counts, fragments = frags.LL.M.NAC)
LL.M.NAC.atac.final <- CreateSeuratObject(LL.M.NAC.chrom_assay, assay = "ATAC", meta.data=md.LL.M.NAC)

LL.F.VHIPP.chrom_assay <- CreateChromatinAssay(counts = LL.F.VHIPP.counts, fragments = frags.LL.F.VHIPP)
LL.F.VHIPP.atac.final <- CreateSeuratObject(LL.F.VHIPP.chrom_assay, assay = "ATAC", meta.data=md.LL.F.VHIPP)

LL.M.VHIPP.chrom_assay <- CreateChromatinAssay(counts = LL.M.VHIPP.counts, fragments = frags.LL.M.VHIPP)
LL.M.VHIPP.atac.final <- CreateSeuratObject(LL.M.VHIPP.chrom_assay, assay = "ATAC", meta.data=md.LL.M.VHIPP)

LL.F1.DG.chrom_assay <- CreateChromatinAssay(counts = LL.F1.DG.counts, fragments = frags.LL.F1.DG)
LL.F1.DG.atac.final <- CreateSeuratObject(LL.F1.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.F1.DG)

LL.F2.DG.chrom_assay <- CreateChromatinAssay(counts = LL.F2.DG.counts, fragments = frags.LL.F2.DG)
LL.F2.DG.atac.final <- CreateSeuratObject(LL.F2.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.F2.DG)

LL.M1.DG.chrom_assay <- CreateChromatinAssay(counts = LL.M1.DG.counts, fragments = frags.LL.M1.DG)
LL.M1.DG.atac.final <- CreateSeuratObject(LL.M1.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.M1.DG)

LL.M2.DG.chrom_assay <- CreateChromatinAssay(counts = LL.M2.DG.counts, fragments = frags.LL.M2.DG)
LL.M2.DG.atac.final <- CreateSeuratObject(LL.M2.DG.chrom_assay, assay = "ATAC", meta.data=md.LL.M2.DG)

# Add information to identify dataset of origin

Idents(LL.F.NAC.atac.final) <- "LL.F.NAC"
Idents(LL.M.NAC.atac.final) <- "LL.M.NAC"
Idents(LL.F.VHIPP.atac.final) <- "LL.F.VHIPP"
Idents(LL.M.VHIPP.atac.final) <- "LL.M.VHIPP"
Idents(LL.F1.DG.atac.final) <- "LL.F1.DG"
Idents(LL.F2.DG.atac.final) <- "LL.F2.DG"
Idents(LL.M1.DG.atac.final) <- "LL.M1.DG"
Idents(LL.M2.DG.atac.final) <- "LL.M2.DG"

LL.F.NAC.atac.final$dataset <- "LL.F.NAC"
LL.M.NAC.atac.final$dataset <- "LL.M.NAC"
LL.F.VHIPP.atac.final$dataset <- "LL.F.VHIPP"
LL.M.VHIPP.atac.final$dataset <- "LL.M.VHIPP"
LL.F1.DG.atac.final$dataset <- "LL.F1.DG"
LL.F2.DG.atac.final$dataset <- "LL.F2.DG"
LL.M1.DG.atac.final$dataset <- "LL.M1.DG"
LL.M2.DG.atac.final$dataset <- "LL.M2.DG"

# Merge Seurat objects

all.normalized.atac <- merge(LL.F.NAC.atac.final, y = c(LL.M.NAC.atac.final,LL.F.VHIPP.atac.final,LL.M.VHIPP.atac.final,LL.F1.DG.atac.final,LL.F2.DG.atac.final,LL.M1.DG.atac.final,LL.M2.DG.atac.final), add.cell.ids=c("LL.F.NAC","LL.M.NAC","LL.F.VHIPP","LL.M.VHIPP","LL.F1.DG","LL.F2.DG","LL.M1.DG","LL.M2.DG"), project="Raj", merge.data=TRUE)

all.normalized.atac[["ATAC"]]

# subset with passing cells after hard filter only

all.normalized.atac.final <- all.normalized.atac[,rownames(all.normalized.atac@meta.data)%in%capture.post.hard.filter.cells]
all.normalized.atac.final[["ATAC"]]

temp1 <- table(all.normalized.atac.final@meta.data$dataset)
svg("1_barplot_number_cells_per_sample.svg")
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
dev.off()
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)

# Run pre-process steps

all.normalized.atac.final <- RunTFIDF(all.normalized.atac.final)
all.normalized.atac.final <- FindTopFeatures(all.normalized.atac.final, min.cutoff = 20)
all.normalized.atac.final <- RunSVD(all.normalized.atac.final)
all.normalized.atac.final <- RunUMAP(all.normalized.atac.final, dims = 2:50, reduction = 'lsi')

# inspect by UMAP

dev.off()
svg("2_umap_group_by_dataset.svg")
DimPlot(all.normalized.atac.final, group.by = 'dataset', pt.size = 0.1)
dev.off()
DimPlot(all.normalized.atac.final, group.by = 'dataset', pt.size = 0.1)

dev.off()
svg("3_umap_split_by_dataset.svg")
DimPlot(all.normalized.atac.final, split.by = 'dataset', pt.size = 0.1,ncol=4)
dev.off()
DimPlot(all.normalized.atac.final, split.by = 'dataset', pt.size = 0.1,ncol=4)

# add gene annotations

annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevels(annotations) <- paste0('chr', seqlevels(annotations))
genome(annotations) <- "mm10"
Annotation(all.normalized.atac.final) <- annotations

# inspect by genomic locus

# Penk
svg("4_coverage_plot_penk.svg")
CoveragePlot(
  object = all.normalized.atac.final,
  group.by = 'dataset',
  region = "chr4-4132531-4139477"
)
dev.off()
CoveragePlot(
  object = all.normalized.atac.final,
  group.by = 'dataset',
  region = "chr4-4132531-4139477"
)

# Sorcs3
svg("5_coverage_plot_sorcs3.svg")
CoveragePlot(
  object = all.normalized.atac.final,
  group.by = 'dataset',
  region = "chr19-48205025-48806505"
)
dev.off()
CoveragePlot(
  object = all.normalized.atac.final,
  group.by = 'dataset',
  region = "chr19-48205025-48806505"
)

# Chgb
svg("6_coverage_plot_chgb.svg")
CoveragePlot(
  object = all.normalized.atac.final,
  group.by = 'dataset',
  region = "chr2-132781278-132795079"
)
dev.off()
CoveragePlot(
  object = all.normalized.atac.final,
  group.by = 'dataset',
  region = "chr2-132781278-132795079"
)




saveRDS(object = all.normalized.atac.final, file = "all.normalized.atac.final.rds")

save.image("Rsession_20231021.RData")

# all.normalized.atac <- readRDS("all.normalized.atac.rds")

# Inspect
# https://stuartlab.org/signac/articles/mouse_brain_vignette.html

atac.drilldown <- all.normalized.atac
DefaultAssay(atac.drilldown) <- "ATAC"
# Idents(atac.drilldown) <- "All Cells"

temp1 <- table(atac.drilldown@meta.data$dataset)
svg("1_atac_primary_inspection_barplot_number_cells_per_sample.svg")
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
dev.off()
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)

atac.drilldown <- NucleosomeSignal(object = atac.drilldown)
atac.drilldown <- TSSEnrichment(atac.drilldown, fast = FALSE)

atac.drilldown$high.tss <- ifelse(atac.drilldown$TSS.enrichment > 2, 'High', 'Low')
TSSPlot(atac.drilldown, group.by = 'high.tss') + NoLegend()

atac.drilldown$log2_peak_region_fragments <- log2(atac.drilldown$atac_peak_region_fragments+2)
atac.drilldown$log2_nCount_ATAC <- log2(atac.drilldown$nCount_ATAC+2)
atac.drilldown$pct_reads_in_peaks <- (atac.drilldown$atac_peak_region_fragments / atac.drilldown$atac_fragments) * 100
atac.drilldown$log2_atac_TSS_fragments <- log2(atac.drilldown$atac_TSS_fragments+2)
atac.drilldown$log2_nucleosome_signal <- log2(atac.drilldown$nucleosome_signal+2)
atac.drilldown$log2_TSS_enrichment <- log2(atac.drilldown$TSS.enrichment+2)

# atac.drilldown$blacklist_ratio <- atac.drilldown$blacklist_region_fragments / atac.drilldown$peak_region_fragments

# nCount

v <- VlnPlot(
  object = atac.drilldown,
  features = c('nCount_ATAC','log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 2
)
v
svg("2_atac_primary_inspection_violin_plot_nCount.svg")
print(v)
dev.off()

svg("3_atac_primary_inspection_density_plot_log2_nCount.svg")
plot(density(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)),main="log2_nCount_ATAC")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))))
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = atac.drilldown,
  features = c('log2_nCount_ATAC'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))),color="black",linetype=c(3)) + geom_hline(yintercept=250,color="black",linetype=c(3))
v
svg("4_atac_primary_inspection_violin_plot_log2_nCount_with_selected_cutoffs.svg")
print(v)
dev.off()

# peak_region_fragments

v <- VlnPlot(
  object = atac.drilldown,
  features = c('atac_peak_region_fragments','log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("5_atac_primary_inspection_violin_plot_log2_peak_region_fragments.svg")
print(v)
dev.off()

svg("6_atac_primary_inspection_density_plot_log2_peak_region_fragments.svg")
plot(density(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)),main="log2_peak_region_fragments")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))))
legend("topright",c("+/- 1SD","+/- 2SD","+/- 3SD","+/- 4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = atac.drilldown,
  features = c('log2_peak_region_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3)) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))),color="black",linetype=c(3))
v
svg("7_atac_primary_inspection_violin_plot_log2_peak_region_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

# pct_reads_in_peaks

v <- VlnPlot(
  object = atac.drilldown,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
)
v
svg("8_atac_primary_inspection_violin_plot_pct_reads_in_peaks.svg")
print(v)
dev.off()

svg("9_atac_primary_inspection_density_plot_pct_reads_in_peaks.svg")
plot(density(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)),main="pct_reads_in_peaks")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-1*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-3*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-4*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))))
legend("topright",c("+/-1SD","+/-2SD","+/-3SD","+/-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = atac.drilldown,
  features = c('pct_reads_in_peaks'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2)) + 
geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))),color="black",linetype=c(2))
v
svg("10_atac_primary_inspection_violin_plot_pct_reads_in_peaks_with_selected_cutoffs.svg")
print(v)
dev.off()

# log2_TSS_fragments

v <- VlnPlot(
  object = atac.drilldown,
  features = c('atac_TSS_fragments','log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 2
)
v
svg("11_atac_primary_inspection_violin_plot_log2_TSS_fragments.svg")
print(v)
dev.off()

svg("12_atac_primary_inspection_density_plot_log2_TSS_fragments.svg")
plot(density(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)),main="log2_atac_TSS_fragments")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))))
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = atac.drilldown,
  features = c('log2_atac_TSS_fragments'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))),color="black",linetype=c(3))
v

svg("13_atac_primary_inspection_violin_plot_log2_TSS_fragments_with_selected_cutoff.svg")
print(v)
dev.off()

v <- VlnPlot(
  object = atac.drilldown,
  features = c('TSS.enrichment','log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 2
)
v
svg("14_atac_primary_inspection_violin_plot_log2_TSS_enrichment.svg")
print(v)
dev.off()

svg("15_atac_primary_inspection_density_plot_log2_TSS_enrichment.svg")
plot(density(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)),main="log2_TSS_enrichment")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-3*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-4*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))))
legend("topright",c("-1SD","-2SD","-3SD","-4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = atac.drilldown,
  features = c('log2_TSS_enrichment'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))),color="black",linetype=c(3))
v

svg("16_atac_primary_inspection_violin_plot_log2_TSS_enrichment_with_selected_cutoff.svg")
print(v)
dev.off()

v <- VlnPlot(
  object = atac.drilldown,
  features = c('nucleosome_signal','log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 2
)
v
svg("17_atac_primary_inspection_violin_plot_log2_nucleosome_signal.svg")
print(v)
dev.off()

svg("18_atac_primary_inspection_density_plot_log2_nucleosome_signal.svg")
plot(density(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))
dev.off()
plot(density(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)),main="log2_nucleosome_signal")
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=2)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(1*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=3)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=4)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(3*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=5)
(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(4*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
abline(v=(mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(-1*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal)))),lty=2)
legend("topright",c("1SD","2SD","3SD","4SD"),lwd=2,lty=c(2,3,4,5))

v <- VlnPlot(
  object = atac.drilldown,
  features = c('log2_nucleosome_signal'),
  pt.size = 0,
  ncol = 1
) + geom_hline(yintercept=mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))),color="black",linetype=c(3))
v
svg("19_atac_primary_inspection_violin_plot_log2_nucleosome_signal_with_selected_cutoff.svg")
print(v)
dev.off()

# hard filter

atac.drilldown
atac.drilldown <- subset(
  x = atac.drilldown,
  subset = log2_nCount_ATAC > mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))) & log2_nCount_ATAC < mean(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nCount_ATAC))) & log2_peak_region_fragments > mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))) & log2_peak_region_fragments < mean(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_peak_region_fragments))) & pct_reads_in_peaks > mean(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))+(-2*sd(as.numeric(atac.drilldown@meta.data$pct_reads_in_peaks))) & log2_atac_TSS_fragments > mean(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_atac_TSS_fragments))) & log2_TSS_enrichment > mean(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))+(-2*sd(as.numeric(atac.drilldown@meta.data$log2_TSS_enrichment))) & log2_nucleosome_signal < mean(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))+(2*sd(as.numeric(atac.drilldown@meta.data$log2_nucleosome_signal))))
atac.drilldown

saveRDS(atac.drilldown,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.drilldown.post.filter.rds")

temp1 <- table(atac.drilldown@meta.data$dataset)
svg("20_atac_post_hard_filtering_barplot_number_cells_per_sample.svg")
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
dev.off()
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)

# identify and remove doublet cells by sample
# https://bioconductor.org/packages/devel/bioc/vignettes/scDblFinder/inst/doc/scATAC.html

options(warn=-1)
all.list <- SplitObject(atac.drilldown, split.by = "dataset")
to.remove <- NULL
for(i in 1:length(all.list)) {
	print(i)
	temp.grab <- all.list[[i]]
	temp.grab.sce <- as.SingleCellExperiment(temp.grab)
	temp.grab.sce <- scDblFinder(temp.grab.sce, artificialDoublets=1, aggregateFeatures=TRUE, nfeatures=25, processing="normFeatures")
	temp.doublet <- rownames(colData(temp.grab.sce))[temp.grab.sce$scDblFinder.class=="doublet"]
	to.remove <- c(to.remove,temp.doublet)
}
options(warn=0)
length(to.remove)

duplicate.status.by.sample <- rownames(atac.drilldown@meta.data)%!in%to.remove
atac.drilldown@meta.data$duplicate.status.by.sample <- factor(duplicate.status.by.sample)
atac.drilldown <- atac.drilldown[,atac.drilldown@meta.data$duplicate.status.by.sample=="TRUE"]

temp1 <- table(atac.drilldown@meta.data$dataset)
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
svg("21_atac_post_doublet_cell_filtering_by_sample_barplot_number_cells_per_sample.svg")
temp1 <- table(atac.drilldown@meta.data$dataset)
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
dev.off()

# dimension reduction

atac.drilldown <- RunTFIDF(atac.drilldown)
atac.drilldown <- FindTopFeatures(atac.drilldown, min.cutoff = 'q0')
atac.drilldown <- RunSVD(object = atac.drilldown)

d <- DepthCor(atac.drilldown)
svg("22_atac_post_dimension_reduction_barplot.svg")
print(d)
dev.off()

atac.drilldown <- RunUMAP(
  object = atac.drilldown,
  reduction = 'lsi',
  dims = 2:30
)
atac.drilldown <- FindNeighbors(
  object = atac.drilldown,
  reduction = 'lsi',
  dims = 2:30
)

svg("23_atac_post_doublet_cell_filtering_by_sample_umap.svg")
DimPlot(object = atac.drilldown, label = FALSE, group.by="dataset",repel=T)
dev.off()
DimPlot(object = atac.drilldown, label = FALSE, group.by="dataset",repel=T)

# identify and remove doublet cells across samples
# https://bioconductor.org/packages/devel/bioc/vignettes/scDblFinder/inst/doc/scATAC.html

options(warn=-1)
temp.grab <- atac.drilldown
temp.grab.sce <- as.SingleCellExperiment(temp.grab)
temp.grab.sce <- scDblFinder(temp.grab.sce, artificialDoublets=1, aggregateFeatures=TRUE, nfeatures=25, processing="normFeatures")
temp.doublet <- rownames(colData(temp.grab.sce))[temp.grab.sce$scDblFinder.class=="doublet"]
options(warn=0)
length(temp.doublet)

duplicate.status.cross.sample <- rownames(atac.drilldown@meta.data)%!in%temp.doublet
atac.drilldown@meta.data$duplicate.status.cross.sample <- factor(duplicate.status.cross.sample)

svg("24_atac_post_doublet_cell_filtering_cross_sample_umap.svg")
DimPlot(object = atac.drilldown, label = FALSE, group.by="duplicate.status.cross.sample",repel=T)
dev.off()
DimPlot(object = atac.drilldown, label = FALSE, group.by="duplicate.status.cross.sample",repel=T)

final.atac.drilldown <- atac.drilldown[,atac.drilldown@meta.data$duplicate.status.cross.sample=="TRUE"]

temp1 <- table(final.atac.drilldown@meta.data$dataset)
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
svg("25_atac_post_doublet_cell_filtering_cross_sample_barplot_number_cells_per_sample.svg")
temp1 <- table(final.atac.drilldown@meta.data$dataset)
ccc <- hue_pal()(8)
par(mar=c(11,4,4,2))
barplot(as.numeric(temp1),ylab="nCells",names.arg = names(temp1),las = 2,col=ccc) + theme(axis.text.x = element_text(angle = 90))
abline(h=0)
dev.off()

# repeat dimension reduction

final.atac.drilldown <- RunTFIDF(final.atac.drilldown)
final.atac.drilldown <- FindTopFeatures(final.atac.drilldown, min.cutoff = 'q0')
final.atac.drilldown <- RunSVD(object = final.atac.drilldown)

d <- DepthCor(final.atac.drilldown)
svg("26_atac_post_repeat_dimension_reduction_barplot.svg")
print(d)
dev.off()

final.atac.drilldown <- RunUMAP(
  object = final.atac.drilldown,
  reduction = 'lsi',
  dims = 2:30
)
final.atac.drilldown <- FindNeighbors(
  object = final.atac.drilldown,
  reduction = 'lsi',
  dims = 2:30
)

# perform clustering

final.atac.drilldown <- FindClusters(
  object = final.atac.drilldown,
  algorithm = 3,
  resolution = c(0.04,0.05,0.06,0.07,0.08,0.09,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2.0,2.1,2.2,2.3,2.4,2.5),
  verbose = FALSE
)

svg("27_atac_post_clustering_clustree_results.svg",width=10,height=20)
clustree(final.atac.drilldown,prefix="ATAC_snn_res.")
dev.off()
clustree(final.atac.drilldown,prefix="ATAC_snn_res.")

pdf("28_atac_post_clustering_umap_plots_per_resolution.pdf")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.04)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.04 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.04, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.04")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.05)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.05 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.05, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.05")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.06)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.06 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.06, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.06")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.07)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.07 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.07, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.07")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.08)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.08 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.08, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.08")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.09)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.09 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.09, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.09")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.1)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.1 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.1, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.1")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.2)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.2 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.2, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.2")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.3)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.3 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.3, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.3")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.4)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.4 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.4, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.4")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.5)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.5 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.5, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.5")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.6)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.6 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.6, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.6")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.7)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.7 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.7, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.7")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.8)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.8 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.8, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.8")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.9)))))
final.atac.drilldown@meta.data$RNA_snn_res.0.9 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.9, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.9")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1)))))
final.atac.drilldown@meta.data$RNA_snn_res.1 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.1)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.1 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.1, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.1")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.2)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.2 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.2, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.2")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.3)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.3 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.3, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.3")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.4)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.4 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.4, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.4")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.5)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.5 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.5, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.5")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.6)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.6 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.6, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.6")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.7)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.7 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.7, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.7")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.8)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.8 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.8, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.8")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.1.9)))))
final.atac.drilldown@meta.data$RNA_snn_res.1.9 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.1.9, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.1.9")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.2)))))
final.atac.drilldown@meta.data$RNA_snn_res.2 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.2, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.2")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.2.1)))))
final.atac.drilldown@meta.data$RNA_snn_res.2.1 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.2.1, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.2.1")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.2.2)))))
final.atac.drilldown@meta.data$RNA_snn_res.2.2 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.2.2, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.2.2")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.2.3)))))
final.atac.drilldown@meta.data$RNA_snn_res.2.3 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.2.3, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.2.3")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.2.4)))))
final.atac.drilldown@meta.data$RNA_snn_res.2.4 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.2.4, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.2.4")

my_levels <- as.character(c(0:length(table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.2.5)))))
final.atac.drilldown@meta.data$RNA_snn_res.2.5 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.2.5, levels=my_levels)
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.2.5")

dev.off()

saveRDS(object = atac.drilldown, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.drilldown.rds")
saveRDS(object = final.atac.drilldown, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.drilldown.rds")

final.atac.drilldown <- readRDS("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.drilldown.rds")

final.atac.drilldown@meta.data$ATAC_snn_res.0.3 <- factor(x=final.atac.drilldown@meta.data$ATAC_snn_res.0.3, levels=as.character(c(0:14)))
Idents(final.atac.drilldown) <- final.atac.drilldown@meta.data$ATAC_snn_res.0.3
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.3",repel=TRUE)
svg("29_atac_post_clustering_umap_for_res_0.3.svg")
DimPlot(final.atac.drilldown, label=TRUE,group.by="ATAC_snn_res.0.3",repel=TRUE)
dev.off()

temp3 <- table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.3))
temp4 <- as.data.frame(cbind(names(temp3),as.numeric(temp3)))
temp5 <- temp4[,2]
names(temp5) <- temp4[,1]
temp5 <- temp5[as.character(c(0:14))]
ccc <- hue_pal()(length(temp5))
barplot(as.numeric(temp5),col=ccc,xlab="Cluster",ylab="nCells",names.arg = names(temp5),las = 2)
abline(h=0)
svg("30_atac_post_clustering_barplot_number_cells_per_cluster_for_res_0.3.svg")
temp3 <- table(as.character(final.atac.drilldown@meta.data$ATAC_snn_res.0.3))
temp4 <- as.data.frame(cbind(names(temp3),as.numeric(temp3)))
temp5 <- temp4[,2]
names(temp5) <- temp4[,1]
temp5 <- temp5[as.character(c(0:14))]
ccc <- hue_pal()(length(temp5))
barplot(as.numeric(temp5),col=ccc,xlab="Cluster",ylab="nCells",names.arg = names(temp5),las = 2)
abline(h=0)
dev.off()

# perform recoding 1,7 -> 1

temp <- as.character(unlist(final.atac.drilldown@meta.data$ATAC_snn_res.0.3))
temp <- ifelse(temp=="7","1",temp)
final.atac.drilldown@meta.data$final.atac.clusters <- factor(temp,levels=as.character(c(0:6,8:14)))
Idents(final.atac.drilldown) <- final.atac.drilldown@meta.data$final.atac.clusters

svg("31_atac_post_clustering_umap_for_res_0.3_recoded.svg")
DimPlot(final.atac.drilldown, label=TRUE,group.by="final.atac.clusters")
dev.off()
DimPlot(final.atac.drilldown, label=TRUE,group.by="final.atac.clusters")

temp3 <- table(as.character(final.atac.drilldown@meta.data$final.atac.clusters))
temp4 <- as.data.frame(cbind(names(temp3),as.numeric(temp3)))
temp5 <- temp4[,2]
names(temp5) <- temp4[,1]
temp5 <- temp5[as.character(c(0:14))]
ccc <- hue_pal()(length(temp5))
barplot(as.numeric(temp5),col=ccc,xlab="Cluster",ylab="nCells",names.arg = names(temp5),las = 2)
abline(h=0)
svg("32_atac_post_clustering_barplot_for_res_0.3_recoded.svg")
temp3 <- table(as.character(final.atac.drilldown@meta.data$final.atac.clusters))
temp4 <- as.data.frame(cbind(names(temp3),as.numeric(temp3)))
temp5 <- temp4[,2]
names(temp5) <- temp4[,1]
temp5 <- temp5[as.character(c(0:13))]
ccc <- hue_pal()(length(temp5))
barplot(as.numeric(temp5),col=ccc,xlab="Cluster",ylab="nCells",names.arg = names(temp5),las = 2)
abline(h=0)
dev.off()

# perform cluster by cluster pruning

to.do <- names((table(Idents(final.atac.drilldown))))
length(to.do)

to.remove <- NULL

i <- 1
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=1.5,lty=2)
abline(h=2,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>1.5
temp10[,2] <- temp10[,2]>2
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 2
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=1.25,lty=2)
abline(h=1.25,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>1.25
temp10[,2] <- temp10[,2]>1.25
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 3
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 4
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2.25,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2.25
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 5
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 6
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2.5,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2.5
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 7
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=1,lty=2)
abline(h=1,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>1
temp10[,2] <- temp10[,2]>1
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=3,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]<2
temp10[,2] <- temp10[,2]>3
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>=2]
temp2@meta.data$new.cluster.to.add <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="new.cluster.to.add"))
to.keep <- rownames(temp2@meta.data)[temp2@meta.data$new.cluster.to.add=="TRUE"]

temp1 <- rownames(final.atac.drilldown@meta.data)
temp2 <- final.atac.drilldown@meta.data$final.atac.clusters
names(temp2) <- temp1
temp3 <- as.factor(rep("15",length(to.keep)))
names(temp3) <- to.keep
temp4 <- temp2[names(temp2)%!in%to.keep]
temp5 <- c(temp4,temp3)[rownames(final.atac.drilldown@meta.data)]
final.atac.drilldown@meta.data$final.atac.clusters <- temp5
to.remove <- setdiff(to.remove,to.keep)

i <- 8
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=1.75,lty=2)
abline(h=3,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>1.75
temp10[,2] <- temp10[,2]>3
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 9
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 10
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 11
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=1.5,lty=2)
abline(h=1.5,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>1.5
temp10[,2] <- temp10[,2]>1.5
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 12
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=1.5,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>1.5
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 13
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=2,lty=2)
abline(h=2,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>2
temp10[,2] <- temp10[,2]>2
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

i <- 14
temp2 <- final.atac.drilldown[,(final.atac.drilldown@meta.data$final.atac.clusters==to.do[i])]
temp3 <- DimPlot(temp2, label=FALSE,group.by="final.atac.clusters")
temp4 <- temp3$data[,1]
temp5 <- temp3$data[,2]
temp6 <- mean(temp4,trim=0.20)
temp7 <- mean(temp5,trim=0.20)
temp44 <- abs((temp4-temp6)/sd(temp4))
temp55 <- abs((temp5-temp7)/sd(temp5))
X <- as.matrix(cbind(temp44,temp55))
dimnames(X)[[1]] <- colnames(temp2)
plot(X, cex = 0.5)
abline(v=1.5,lty=2)
abline(h=1.5,lty=2)
temp10 <- X
temp10[,1] <- temp10[,1]>1.5
temp10[,2] <- temp10[,2]>1.5
temp11 <- dimnames(temp10)[[1]][apply(temp10,1,sum)>0]
temp2@meta.data$outliers <- rownames(temp2@meta.data)%in%temp11
print(DimPlot(temp2, label=FALSE,group.by="outliers") + ggtitle(paste(c("Cluster ",i," Outliers"),sep="",collapse="")))
to.remove <- c(to.remove,temp11)

final.atac.pruned <- final.atac.drilldown
final.atac.pruned@meta.data$pruned <- colnames(final.atac.pruned)%in%to.remove

DimPlot(final.atac.pruned, label=FALSE,group.by="pruned")
svg("33_atac_post_pruning_umap_for_res_0.3_recoded_split_by_True_False.svg")
DimPlot(final.atac.pruned, label=FALSE,group.by="pruned")
dev.off()

final.atac.pruned <- final.atac.pruned[,final.atac.pruned@meta.data$pruned=="FALSE"]

# Characterize

DimPlot(final.atac.pruned, label=FALSE,group.by="final.atac.clusters")
svg("34_atac_final_umap_by_cluster_v1.svg")
DimPlot(final.atac.pruned, label=FALSE,group.by="final.atac.clusters")
dev.off()

DimPlot(final.atac.pruned, label=TRUE,group.by="final.atac.clusters",repel=TRUE)
svg("35_atac_final_umap_by_cluster_v2.svg")
DimPlot(final.atac.pruned, label=TRUE,group.by="final.atac.clusters",repel=TRUE)
dev.off()

DimPlot(final.atac.pruned, label=TRUE,group.by="final.atac.clusters",repel=TRUE) + NoLegend()
svg("36_atac_final_umap_by_cluster_v3.svg")
DimPlot(final.atac.pruned, label=TRUE,group.by="final.atac.clusters",repel=TRUE) + NoLegend()
dev.off()

DimPlot(final.atac.pruned, label=FALSE, group.by="dataset")
svg("37_atac_final_umap_by_sample.svg")
DimPlot(final.atac.pruned, label=FALSE, group.by="dataset")
dev.off()

DimPlot(final.atac.pruned, reduction = "umap", split.by = "dataset",ncol=3)
svg("38_atac_final_umap_split_by_sample.svg",width=20,height=20)
DimPlot(final.atac.pruned, reduction = "umap", split.by = "dataset",ncol=3)
dev.off()

level.order <- as.character(c(0:6,8:15))
temp <- table(final.atac.pruned@meta.data$final.atac.clusters)
temp <- as.data.frame(cbind(names(temp),as.numeric(as.character(temp))))
dimnames(temp)[[2]] <- c("Cluster","nCells")
temp$Cluster <- factor(temp$Cluster,levels=level.order)
temp$nCells <- as.numeric(as.character(temp$nCells))
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Cluster)) +  geom_bar(stat = "identity") + xlab("Cluster")) + theme(axis.text.x = element_text(angle = 45, hjust=1))
svg("39_atac_final_barplot_cluster_nCells.svg",width=20)
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Cluster)) +  geom_bar(stat = "identity") + xlab("Cluster")) + theme(axis.text.x = element_text(angle = 45, hjust=1))
dev.off()

level.order <- as.character(c(0:6,8:15))
temp <- final.atac.pruned@meta.data
pos.dataset <- c(1:length(names(final.atac.pruned@meta.data)))[names(final.atac.pruned@meta.data)=="dataset"]
pos.final.atac.clusters <- c(1:length(names(final.atac.pruned@meta.data)))[names(final.atac.pruned@meta.data)=="final.atac.clusters"]
temp <- as.data.frame(temp[,c(pos.dataset,pos.final.atac.clusters)])
temptemp <- apply(temp,1,paste,collapse="_",sep="_")
temptemptemp <- table(temptemp)
temp <- cbind(names(temptemptemp),as.numeric(temptemptemp))
temptemp <- str_split(as.character(temp[,1]),"_")
temptemp <- as.data.frame(temptemp)
temptemp <- t(temptemp)
temp <- cbind(temp,temptemp)
temptemp <- temp[,c(3:5)]
temptemp <- apply(temptemp,1,paste,collapse="_",sep="_")
temp <- cbind(temp,temptemp)
rownames(temp) <- temp[,1]
temp[,1] <- temp[,7]
temp <- temp[,-c(7)]
temp <- temp[,c(1,6,2)]
dimnames(temp)[[2]] <- c("Sample","Cluster","nCells")
temp <- as.data.frame(temp)
temp$Cluster <- factor(as.character(temp$Cluster),levels=level.order)
temp$nCells <- as.numeric(as.character(temp$nCells))
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Sample)) + geom_bar(stat = "identity",position="stack") + xlab('Cluster') + ylab('nCells') + theme(axis.text.x = element_text(angle = 45, hjust=1)))
svg("40_atac_final_barplot_by_cluster_vs_sample_breakdown.svg",width=10)
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Sample)) + geom_bar(stat = "identity",position="stack") + xlab('Cluster') + ylab('nCells') + theme(axis.text.x = element_text(angle = 45, hjust=1)))
dev.off()

print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Sample)) + geom_bar(stat = "identity",position="fill") + xlab('Cluster') + ylab('Proportion') + theme(axis.text.x = element_text(angle = 45, hjust=1)))
svg("41_atac_final_barplot_by_cluster_vs_sample_proportion.svg",width=10)
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Sample)) + geom_bar(stat = "identity",position="fill") + xlab('Cluster') + ylab('Proportion') + theme(axis.text.x = element_text(angle = 45, hjust=1)))
dev.off()

saveRDS(object = final.atac.pruned, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")

# compute gene activities

gene.activities <- GeneActivity(final.atac.pruned)
saveRDS(object = gene.activities, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/gene.activities.rds")

# add the gene activity matrix to the Seurat object as a new assay

final.atac.pruned[['RNA']] <- CreateAssayObject(counts = gene.activities)
final.atac.pruned <- NormalizeData(
  object = final.atac.pruned,
  assay = 'RNA',
  normalization.method = 'LogNormalize',
  scale.factor = median(final.atac.pruned$nCount_RNA)
)

saveRDS(object = final.atac.pruned, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")

final.annotated.harmony.go <- readRDS("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.annotated.harmony.go.rds")

final.atac.pruned <- readRDS("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")

# find trasnfer anchors between GEX and ATAC objects

final.annotated.harmony.go <- FindVariableFeatures(
  object = final.annotated.harmony.go,
  nfeatures = 5000
)

DefaultAssay(final.atac.pruned) <- 'RNA'

transfer.anchors <- FindTransferAnchors(
  reference = final.annotated.harmony.go,
  query = final.atac.pruned,
  reduction = 'cca',
  features = intersect(VariableFeatures(final.annotated.harmony.go),rownames(final.atac.pruned))
)

saveRDS(object = transfer.anchors, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/transfer.anchors.rds")

final.predicted.atac.labels <- TransferData(
  anchorset = transfer.anchors,
  refdata = final.annotated.harmony.go$final.annotations,
  weight.reduction = final.atac.pruned[['lsi']],
  dims = 2:30
)

final.atac.pruned <- AddMetaData(object = final.atac.pruned, metadata = final.predicted.atac.labels)

plot1 <- DimPlot(final.annotated.harmony.go, group.by = 'final.annotations', label = TRUE, repel = TRUE) + ggtitle('scRNA-seq')
plot2 <- DimPlot(final.atac.pruned, group.by = 'predicted.id', label = TRUE, repel = TRUE) + ggtitle('scATAC-seq')
plot3 <- plot1 + plot2
plot3
svg("42_atac_post_label_transfer_umap.svg",width=20,height=10)
print(plot3)
dev.off()

# characterize clusters by label

level.order <- as.character(c(0:6,8:15))
temp <- final.atac.pruned@meta.data
pos.cluster <- c(1:length(names(final.atac.pruned@meta.data)))[names(final.atac.pruned@meta.data)=="final.atac.clusters"]
pos.predicted.id <- c(1:length(names(final.atac.pruned@meta.data)))[names(final.atac.pruned@meta.data)=="predicted.id"]
temp <- as.data.frame(temp[,c(pos.predicted.id,pos.cluster)])
temptemp <- apply(temp,1,paste,collapse="_",sep="_")
temptemptemp <- table(temptemp)
temp <- cbind(names(temptemptemp),as.numeric(temptemptemp))
temptemp <- str_split(as.character(temp[,1]),"_")
new.temptemp <- temptemp
for(i in 1:length(temptemp)) {
	print(i)
	t.0 <- temptemp[[i]]
	t.1 <- t.0[length(t.0)]
	t.2 <- t.0[-c(length(t.0))]
	t.3 <- paste(t.2,sep="_",collapse="_")
	new.temptemp[[i]] <- c(t.3,t.1)
}
temptemp <- new.temptemp
temptemp <- as.data.frame(temptemp)
temptemp <- t(temptemp)
temp <- cbind(temp,temptemp)
rownames(temp) <- temp[,1]
temp <- temp[,c(4,3,2)]
dimnames(temp)[[2]] <- c("Cluster","Label","nCells")
temp <- as.data.frame(temp)
temp$Cluster <- factor(as.character(temp$Cluster),levels=level.order)
temp$Label <- factor(as.character(temp$Label))
temp$nCells <- as.numeric(as.character(temp$nCells))
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Label)) + geom_bar(stat = "identity",position="stack") + xlab('Cluster') + ylab('nCells') + theme(axis.text.x = element_text(angle = 45, hjust=1)))
svg("43_atac_post_label_transfer_barplot.svg",width=10)
print(ggplot(temp, aes(x = factor(Cluster, level=level.order), y = nCells, fill = Label)) + geom_bar(stat = "identity",position="stack") + xlab('Cluster') + ylab('nCells') + theme(axis.text.x = element_text(angle = 45, hjust=1)))
dev.off()

saveRDS(final.annotated.harmony.go,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.annotated.harmony.go.rds")

saveRDS(final.atac.pruned,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")

# find differential peaks

final.annotated.harmony.go <- readRDS("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.annotated.harmony.go.rds")

final.atac.pruned <- readRDS("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")

DefaultAssay(final.atac.pruned) <- 'ATAC'

to.do <- as.character(c(0:6,8:15))

# cluster 0

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.0.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "0", 
  ident.2 = setdiff(to.do,"0"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.0.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.0.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_0.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.0.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.0.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_0.svg",height=14)
print(plot3)
dev.off()

# cluster 1

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.1.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "1", 
  ident.2 = setdiff(to.do,"1"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.1.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.1.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_1.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.1.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.1.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_1.svg",height=14)
print(plot3)
dev.off()

options(object.size=Inf)
setwd("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007")

# cluster 2

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.2.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "2", 
  ident.2 = setdiff(to.do,"2"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.2.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.2.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_2.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.2.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.2.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_2.svg",height=14)
print(plot3)
dev.off()

# cluster 3

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.3.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "3", 
  ident.2 = setdiff(to.do,"3"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.3.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.3.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_3.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.3.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.3.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_3.svg",height=14)
print(plot3)
dev.off()

# cluster 4

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.4.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "4", 
  ident.2 = setdiff(to.do,"4"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.4.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.4.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_4.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.4.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.4.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_4.svg",height=14)
print(plot3)
dev.off()

# cluster 5

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.5.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "5", 
  ident.2 = setdiff(to.do,"5"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.5.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.5.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_5.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.5.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.5.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_5.svg",height=14)
print(plot3)
dev.off()

# cluster 6

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.6.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "6", 
  ident.2 = setdiff(to.do,"6"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.6.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.6.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_6.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.6.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.6.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_6.svg",height=14)
print(plot3)
dev.off()

# cluster 8

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.8.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "8", 
  ident.2 = setdiff(to.do,"8"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.8.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.8.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_8.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.8.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.8.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_8.svg",height=14)
print(plot3)
dev.off()

# cluster 9

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.9.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "9", 
  ident.2 = setdiff(to.do,"9"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.9.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.9.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_9.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.9.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.9.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_9.svg",height=14)
print(plot3)
dev.off()

# cluster 10

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.10.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "10", 
  ident.2 = setdiff(to.do,"10"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.10.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.10.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_10.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.10.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.10.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_10.svg",height=14)
print(plot3)
dev.off()

# cluster 11

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.11.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "11", 
  ident.2 = setdiff(to.do,"11"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.11.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.11.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_11.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.11.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.11.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_11.svg",height=14)
print(plot3)
dev.off()

# cluster 12

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.12.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "12", 
  ident.2 = setdiff(to.do,"12"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.12.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.12.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_12.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.12.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.12.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_12.svg",height=14)
print(plot3)
dev.off()

# cluster 13

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.13.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "13", 
  ident.2 = setdiff(to.do,"13"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.13.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.13.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_13.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.13.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.13.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_13.svg",height=14)
print(plot3)
dev.off()

# cluster 14

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.14.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "14", 
  ident.2 = setdiff(to.do,"14"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.14.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.14.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_14.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.14.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.14.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_14.svg",height=14)
print(plot3)
dev.off()

# cluster 15

Idents(final.atac.pruned) <- final.atac.pruned@meta.data$final.atac.clusters
atac.cluster.15.diffx.peaks <- FindMarkers(
  object = final.atac.pruned,
  ident.1 = "15", 
  ident.2 = setdiff(to.do,"15"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'atac_peak_region_fragments'
)
head(atac.cluster.15.diffx.peaks)

wb <- createWorkbook("atac_diffx_peak_testing_results_cluster_2")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.15.diffx.peaks, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac_diffx_peak_testing_results_cluster_15.xlsx", overwrite = TRUE)

plot1 <- VlnPlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.15.diffx.peaks)[1],
  pt.size = 0.1,
  idents = c(as.character(c(0:6,8:15)))
)

plot2 <- FeaturePlot(
  object = final.atac.pruned,
  features = rownames(atac.cluster.15.diffx.peaks)[1],
  pt.size = 0.1,
  max.cutoff = 'q95'
)
plot3 <- plot1 + plot2
plot3
svg("atac_top_diffx_peak_cluster_15.svg",height=14)
print(plot3)
dev.off()

# genomic profile plotting

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.0.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_0_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.0.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.1.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_1_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.1.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.2.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_2_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.2.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.3.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_3_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.3.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.4.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_4_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.4.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.5.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_5_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.5.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.6.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_6_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.6.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.8.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_8_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.8.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.9.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_9_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.9.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.10.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_10_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.10.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.11.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_11_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.11.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.12.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_12_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.12.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.13.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_13_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.13.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.14.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_14_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.14.diffx.peaks)[1],
  ncol = 1
)
dev.off()

levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.15.diffx.peaks)[1],
  ncol = 1
)
svg("atac_top_diffx_peak_cluster_15_genomic_profile.svg")
levels(final.atac.pruned) <- to.do
CoveragePlot(
  object = final.atac.pruned,
  region = rownames(atac.cluster.15.diffx.peaks)[1],
  ncol = 1
)
dev.off()

saveRDS(object = final.atac.pruned, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")

saveRDS(object = atac.cluster.0.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.0.diffx.peaks.rds")
saveRDS(object = atac.cluster.1.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.1.diffx.peaks.rds")
saveRDS(object = atac.cluster.2.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.2.diffx.peaks.rds")
saveRDS(object = atac.cluster.3.diffx.peaks, file =  "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.3.diffx.peaks.rds")
saveRDS(object = atac.cluster.4.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.4.diffx.peaks.rds")
saveRDS(object = atac.cluster.5.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.5.diffx.peaks.rds")
saveRDS(object = atac.cluster.6.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.6.diffx.peaks.rds")
saveRDS(object = atac.cluster.8.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.8.diffx.peaks.rds")
saveRDS(object = atac.cluster.9.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.9.diffx.peaks.rds")
saveRDS(object = atac.cluster.10.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.10.diffx.peaks.rds")
saveRDS(object = atac.cluster.11.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.11.diffx.peaks.rds")
saveRDS(object = atac.cluster.12.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.12.diffx.peaks.rds")
saveRDS(object = atac.cluster.13.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.13.diffx.peaks.rds")
saveRDS(object = atac.cluster.14.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.14.diffx.peaks.rds")
saveRDS(object = atac.cluster.15.diffx.peaks, file = "/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.15.diffx.peaks.rds")

#------------------------------------------------------------------------------
# Overrepresented motif analysis
# https://stuartlab.org/signac/articles/motif_vignette.html#adding-motif-information-to-the-seurat-object
#------------------------------------------------------------------------------

set.seed(1234)

final.atac.pruned <- readRDS("/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.pruned.rds")
DimPlot(final.atac.pruned, label = TRUE, pt.size = 0.1)

# extract motif scoring matrix

pfm <- getMatrixSet(
  x = JASPAR2020,
  opts = list(collection = "CORE", tax_group = 'vertebrates', all_versions = FALSE)
)

# remove non standard chromosomes

final.atac.matrix.analysis <- final.atac.pruned
gr <- granges(final.atac.matrix.analysis)
seq_keep <- seqnames(gr) %in% seqnames(BSgenome.Mmusculus.UCSC.mm10) 
seq_keep <- as.vector(seq_keep)
feat.keep <- GRangesToString(grange = gr[seq_keep])
final.atac.matrix.analysis[['ATAC']] <- subset(final.atac.matrix.analysis[["ATAC"]], features = feat.keep)

# add motif information

final.atac.matrix.analysis <- AddMotifs(
  object = final.atac.matrix.analysis,
  genome = BSgenome.Mmusculus.UCSC.mm10,
  pfm = pfm
)

saveRDS(final.atac.matrix.analysis,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/final.atac.matrix.analysis.rds")

# find open peaks

open.peaks <- AccessiblePeaks(final.atac.matrix.analysis, idents = as.character(c(0:6,8:15)))

saveRDS(open.peaks,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/open.peaks.rds")

# test for diffx peaks per cluster, up only

# cluster 0

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.0.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "0", 
  ident.2 = setdiff(to.do,"0"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.0.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.0.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.0.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.0.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.0.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.0.diffx.peaks.up.only.filtered <- rownames(atac.cluster.0.diffx.peaks.up.only[atac.cluster.0.diffx.peaks.up.only$p_val < 0.005, ])

saveRDS(atac.cluster.0.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.0.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.0.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.0.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.0.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.0 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.0,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.0.rds")

peaks.matched.cluster.0 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.0[open.peaks, ],
  query.feature = meta.feature.cluster.0[atac.cluster.0.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.0,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.0.rds")

# test enrichment

enriched.motifs.cluster.0 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.0.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.0
)

saveRDS(enriched.motifs.cluster.0,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.0.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_0.svg",width=20)
print(plot1)
dev.off()

# cluster 1

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.1.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "1", 
  ident.2 = setdiff(to.do,"1"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.1.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.1.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.1.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.1.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.1.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.1.diffx.peaks.up.only.filtered <- rownames(atac.cluster.1.diffx.peaks.up.only[atac.cluster.1.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.1.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.1.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.1.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.1.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.1.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.1 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.1,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.1.rds")

peaks.matched.cluster.1 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.1[open.peaks, ],
  query.feature = meta.feature.cluster.1[atac.cluster.1.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.1,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.1.rds")

# test enrichment

enriched.motifs.cluster.1 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.1.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.1
)

saveRDS(enriched.motifs.cluster.1,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.1.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_1.svg",width=20)
print(plot1)
dev.off()

# cluster 2

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.2.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "2", 
  ident.2 = setdiff(to.do,"2"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.2.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.2.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.2.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.2.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.2.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.2.diffx.peaks.up.only.filtered <- rownames(atac.cluster.2.diffx.peaks.up.only[atac.cluster.2.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.2.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.2.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.2.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.2.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.2.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.2 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.2,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.2.rds")

peaks.matched.cluster.2 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.2[open.peaks, ],
  query.feature = meta.feature.cluster.2[atac.cluster.2.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.2,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.2.rds")

# test enrichment

enriched.motifs.cluster.2 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.2.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.2
)

saveRDS(enriched.motifs.cluster.2,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.2.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_2.svg",width=20)
print(plot1)
dev.off()

# cluster 3

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.3.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "3", 
  ident.2 = setdiff(to.do,"3"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.3.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.3.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.3.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.3.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.3.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.3.diffx.peaks.up.only.filtered <- rownames(atac.cluster.3.diffx.peaks.up.only[atac.cluster.3.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.3.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.3.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.3.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.3.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.3.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.3 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.3,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.3.rds")

peaks.matched.cluster.3 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.3[open.peaks, ],
  query.feature = meta.feature.cluster.3[atac.cluster.3.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.3,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.3.rds")

# test enrichment

enriched.motifs.cluster.3 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.3.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.3
)

saveRDS(enriched.motifs.cluster.3,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.3.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_3.svg",width=20)
print(plot1)
dev.off()

# cluster 4

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.4.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "4", 
  ident.2 = setdiff(to.do,"4"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.4.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.4.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.4.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.4.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.4.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.4.diffx.peaks.up.only.filtered <- rownames(atac.cluster.4.diffx.peaks.up.only[atac.cluster.4.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.4.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.4.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.4.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.4.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.4.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.4 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.4,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.4.rds")

peaks.matched.cluster.4 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.4[open.peaks, ],
  query.feature = meta.feature.cluster.4[atac.cluster.4.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.4,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.4.rds")

# test enrichment

enriched.motifs.cluster.4 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.4.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.4
)

saveRDS(enriched.motifs.cluster.4,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.4.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_4.svg",width=20)
print(plot1)
dev.off()

# cluster 5

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.5.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "5", 
  ident.2 = setdiff(to.do,"5"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.5.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.5.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.5.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.5.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.5.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.5.diffx.peaks.up.only.filtered <- rownames(atac.cluster.5.diffx.peaks.up.only[atac.cluster.5.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.5.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.5.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.5.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.5.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.5.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.5 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.5,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.5.rds")

peaks.matched.cluster.5 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.5[open.peaks, ],
  query.feature = meta.feature.cluster.5[atac.cluster.5.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.5,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.5.rds")

# test enrichment

enriched.motifs.cluster.5 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.5.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.5
)

saveRDS(enriched.motifs.cluster.5,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.5.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_5.svg",width=20)
print(plot1)
dev.off()

# cluster 6

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.6.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "6", 
  ident.2 = setdiff(to.do,"6"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.6.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.6.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.6.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.6.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.6.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.6.diffx.peaks.up.only.filtered <- rownames(atac.cluster.6.diffx.peaks.up.only[atac.cluster.6.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.6.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.6.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.6.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.6.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.6.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.6 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.6,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.6.rds")

peaks.matched.cluster.6 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.6[open.peaks, ],
  query.feature = meta.feature.cluster.6[atac.cluster.6.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.6,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.6.rds")

# test enrichment

enriched.motifs.cluster.6 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.6.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.6
)

saveRDS(enriched.motifs.cluster.6,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.6.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_6.svg",width=20)
print(plot1)
dev.off()

# cluster 8

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.8.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "8", 
  ident.2 = setdiff(to.do,"8"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.8.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.8.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.8.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.8.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.8.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.8.diffx.peaks.up.only.filtered <- rownames(atac.cluster.8.diffx.peaks.up.only[atac.cluster.8.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.8.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.8.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.8.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.8.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.8.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.8 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.8,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.8.rds")

peaks.matched.cluster.8 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.8[open.peaks, ],
  query.feature = meta.feature.cluster.8[atac.cluster.8.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.8,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.8.rds")

# test enrichment

enriched.motifs.cluster.8 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.8.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.8
)

saveRDS(enriched.motifs.cluster.8,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.8.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_8.svg",width=20)
print(plot1)
dev.off()

# cluster 9

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.9.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "9", 
  ident.2 = setdiff(to.do,"9"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.9.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.9.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.9.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.9.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.9.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.9.diffx.peaks.up.only.filtered <- rownames(atac.cluster.9.diffx.peaks.up.only[atac.cluster.9.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.9.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.9.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.9.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.9.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.9.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.9 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.9,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.9.rds")

peaks.matched.cluster.9 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.9[open.peaks, ],
  query.feature = meta.feature.cluster.9[atac.cluster.9.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.9,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.9.rds")

# test enrichment

enriched.motifs.cluster.9 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.9.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.9
)

saveRDS(enriched.motifs.cluster.9,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.9.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_9.svg",width=20)
print(plot1)
dev.off()

# cluster 10

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.10.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "10", 
  ident.2 = setdiff(to.do,"10"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.10.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.10.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.10.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.10.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.10.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.10.diffx.peaks.up.only.filtered <- rownames(atac.cluster.10.diffx.peaks.up.only[atac.cluster.10.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.10.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.10.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.10.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.10.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.10.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.10 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.10,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.10.rds")

peaks.matched.cluster.10 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.10[open.peaks, ],
  query.feature = meta.feature.cluster.10[atac.cluster.10.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.10,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.10.rds")

# test enrichment

enriched.motifs.cluster.10 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.10.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.10
)

saveRDS(enriched.motifs.cluster.10,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.10.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_10.svg",width=20)
print(plot1)
dev.off()

# cluster 11

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.11.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "11", 
  ident.2 = setdiff(to.do,"11"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.11.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.11.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.11.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.11.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.11.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.11.diffx.peaks.up.only.filtered <- rownames(atac.cluster.11.diffx.peaks.up.only[atac.cluster.11.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.11.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.11.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.11.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.11.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.11.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.11 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.11,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.11.rds")

peaks.matched.cluster.11 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.11[open.peaks, ],
  query.feature = meta.feature.cluster.11[atac.cluster.11.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.11,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.11.rds")

# test enrichment

enriched.motifs.cluster.11 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.11.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.11
)

saveRDS(enriched.motifs.cluster.11,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.11.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_11.svg",width=20)
print(plot1)
dev.off()

# cluster 12

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.12.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "12", 
  ident.2 = setdiff(to.do,"12"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.12.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.12.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.12.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.12.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.12.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.12.diffx.peaks.up.only.filtered <- rownames(atac.cluster.12.diffx.peaks.up.only[atac.cluster.12.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.12.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.12.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.12.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.12.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.12.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.12 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.12,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.12.rds")

peaks.matched.cluster.12 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.12[open.peaks, ],
  query.feature = meta.feature.cluster.12[atac.cluster.12.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.12,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.12.rds")

# test enrichment

enriched.motifs.cluster.12 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.12.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.12
)

saveRDS(enriched.motifs.cluster.12,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.12.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_12.svg",width=20)
print(plot1)
dev.off()

# cluster 13

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.13.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "13", 
  ident.2 = setdiff(to.do,"13"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.13.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.13.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.13.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.13.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.13.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.13.diffx.peaks.up.only.filtered <- rownames(atac.cluster.13.diffx.peaks.up.only[atac.cluster.13.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.13.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.13.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.13.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.13.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.13.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.13 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.13,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.13.rds")

peaks.matched.cluster.13 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.13[open.peaks, ],
  query.feature = meta.feature.cluster.13[atac.cluster.13.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.13,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.13.rds")

# test enrichment

enriched.motifs.cluster.13 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.13.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.13
)

saveRDS(enriched.motifs.cluster.13,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.13.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_13.svg",width=20)
print(plot1)
dev.off()

# cluster 14

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.14.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "14", 
  ident.2 = setdiff(to.do,"14"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.14.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.14.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.14.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.14.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.14.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.14.diffx.peaks.up.only.filtered <- rownames(atac.cluster.14.diffx.peaks.up.only[atac.cluster.14.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.14.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.14.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.14.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.14.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.14.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.14 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.14,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.14.rds")

peaks.matched.cluster.14 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.14[open.peaks, ],
  query.feature = meta.feature.cluster.14[atac.cluster.14.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.14,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.14.rds")

# test enrichment

enriched.motifs.cluster.14 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.14.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.14
)

saveRDS(enriched.motifs.cluster.14,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.14.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_14.svg",width=20)
print(plot1)
dev.off()

# cluster 15

# test

Idents(final.atac.matrix.analysis) <- final.atac.matrix.analysis@meta.data$final.atac.clusters
atac.cluster.15.diffx.peaks.up.only <- FindMarkers(
  object = final.atac.matrix.analysis,
  ident.1 = "15", 
  ident.2 = setdiff(to.do,"15"), 
  min.pct = 0.05,
  test.use = 'LR',
  latent.vars = 'nCount_ATAC',
  only.pos = TRUE
)

saveRDS(atac.cluster.15.diffx.peaks.up.only,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.15.diffx.peaks.up.only.rds")

wb <- createWorkbook("atac.cluster.15.diffx.peaks.up.only")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.15.diffx.peaks.up.only, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.15.diffx.peaks.up.only.xlsx", overwrite = TRUE)

# filter

atac.cluster.15.diffx.peaks.up.only.filtered <- rownames(atac.cluster.15.diffx.peaks.up.only[atac.cluster.15.diffx.peaks.up.only$p_val < 0.05, ])

saveRDS(atac.cluster.15.diffx.peaks.up.only.filtered,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/atac.cluster.15.diffx.peaks.up.only.filtered.rds")

wb <- createWorkbook("atac.cluster.15.diffx.peaks.up.only.filtered")
addWorksheet(wb, "results")
writeData(wb, sheet = "results", atac.cluster.15.diffx.peaks.up.only.filtered, colNames = TRUE,rowNames = TRUE)
saveWorkbook(wb, "atac.cluster.15.diffx.peaks.up.only.filtered.xlsx", overwrite = TRUE)

# match the overall GC content in the peak set

meta.feature.cluster.15 <- GetAssayData(final.atac.matrix.analysis, assay = "ATAC", slot = "meta.features")

saveRDS(meta.feature.cluster.15,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/meta.feature.cluster.15.rds")

peaks.matched.cluster.15 <- MatchRegionStats(
  meta.feature = meta.feature.cluster.15[open.peaks, ],
  query.feature = meta.feature.cluster.15[atac.cluster.15.diffx.peaks.up.only.filtered, ],
  n = 50000
)

saveRDS(peaks.matched.cluster.15,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/peaks.matched.cluster.15.rds")

# test enrichment

enriched.motifs.cluster.15 <- FindMotifs(
  object = final.atac.matrix.analysis,
  features = atac.cluster.15.diffx.peaks.up.only.filtered,
  background=peaks.matched.cluster.15
)

saveRDS(enriched.motifs.cluster.15,"/data/johnsonko/SideProject/Raj/scRNA_Seq_Project_20221007/enriched.motifs.cluster.15.rds")

# plot

plot1 <- MotifPlot(
  object = final.atac.matrix.analysis,
  motifs = head(rownames(enriched.motifs))
)
plot1

svg("atac_top_enriched_filtered_motifs_cluster_15.svg",width=20)
print(plot1)
dev.off()





























































































































































































































































